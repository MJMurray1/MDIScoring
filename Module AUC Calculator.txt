# This function generates c-statistic or area under the curve (AUC) from the geometric mean expression of transcriptional modules in a single purified cell transcriptional datasets.
# The AUC score relates to the ability of a module's gene expression to discriminate a cell of interest relative to other cell types within a single dataset.
# It requires the R package 'pROC'
# The function relies on the geometric mean gene expression for each module within a dataset, as generated by the "Module statistics" function. 
# The .csv "Module statistics" output files should be deposited in the working directory X\\AUCdirectory 
# AUC scores for modules of a particular cell type require definition of the "CELLOFINTEREST" transcribed exactly as in the dataset being used.
# AUCmean scores are calculated from the average of AUC scores per dataset.

ModuleAUC<-function(AUCDirectory,Dataset,CellNameAUC,HeaderName){

library(pROC)

allfiles <- list.files(AUCDirectory,pattern=Dataset,full.names = TRUE) #List files in AUCDirectory
# each .csv file contains the geometric meanexpression of a module in all the cells in a dataset, including the cell of interest. 
# First column contain name of cell type. One other column contains the geometric mean expression of the module.

AUC <-c() #Create empty results vector

for(i in 1:length(allfiles)){ #Compute AUC
  cellauc <- read.csv(allfiles[i], header = TRUE, sep = ",",check.names = FALSE)
  colnames(cellauc)[1] <- "cell"
  cellauc$cellofinterest <- ifelse(cellauc$cell==CellNameAUC,"1","0") #CellNameAUC is the name of the cell type the modules being tested are purported to represent
  roc1 <- roc(cellauc$cellofinterest, cellauc[[HeaderName]], percent=FALSE) #HeaderName is the title of the column that contains the geometric mean date
  aucnumb <- as.numeric(auc(roc1))
  AUC <- c(AUC,aucnumb)
}
 

SigNameTrimmed<-unlist(strsplit(allfiles,split=AUCDirectory,fixed=TRUE))[seq(from=2,to=2*length(allfiles),by=2)] #Trim Signature and Data set names
SigNameTrimmed<-unlist(strsplit(SigNameTrimmed,split=Dataset,fixed=TRUE))[seq(from=1,to=2*length(allfiles),by=2)]
SigNameTrimmed<-substring(SigNameTrimmed,2)
SigNameTrimmed<-substring(SigNameTrimmed,1,nchar(SigNameTrimmed)-1)

moduleAUC <- cbind(SigNameTrimmed,AUC)
colnames(moduleAUC)<-c("Module Name","AUC")


write.csv(moduleAUC,file=paste(AUCDirectory,"\\",Dataset," Modules AUC.csv",sep=""),row.names=FALSE) # output is a .csv file with 3 columns. 2nd column has name of module. 3rd column contains AUC statistic.
}

